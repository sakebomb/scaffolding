# Architecture

What scaffold generates and how the pieces fit together.

## CLAUDE.md — The Agent Constitution

The core of the framework. Defines how Claude Code should behave in your project:

- **Core principles** — simplicity first, no band-aids, minimal impact
- **Guardrails** — never commit to main, never hardcode secrets, confirm before destructive actions
- **Planning workflow** — structured plans in `tasks/todo.md` with checkpoints and approval gates
- **Subagent strategy** — 8 agents with context budgets and orchestration rules
- **Testing tiers** — unit, integration, agent behavior — fail-fast ordering
- **Recovery** — lessons learned system that compounds across sessions

Language-specific conventions (Python, TypeScript, Go, Rust) are appended during init.

## First Session Onboarding

After running `./scaffold`:

1. Run `claude` to start Claude Code
2. Type `/start` — a guided walkthrough that helps you create your first plan and (optionally) your first GitHub issue
3. Or just tell Claude what to build: *"I want to build [your idea]. Help me create a plan."*

A `GETTING_STARTED.md` file is also generated in your project with a full walkthrough and command reference.

## Slash Commands

| Command | What It Does |
|---------|-------------|
| `/start` | Guided first-session onboarding — plan your project and create your first issue |
| `/plan` | Create a structured plan with confidence assessment in `tasks/todo.md` |
| `/review` | Review changes with Four Questions evidence validation |
| `/test` | Run tests by tier, analyze failures, propose fixes |
| `/lesson` | Record a lesson — mistakes, positive patterns, troubleshooting, insights |
| `/checkpoint` | Stage, commit, and update `tasks/todo.md` progress |
| `/status` | Show project progress — plan completion + git state |
| `/simplify` | Analyze code complexity and suggest simplifications |
| `/refactor` | Guided refactoring with before/after test validation |
| `/index` | Generate `PROJECT_INDEX.md` for fast session orientation |
| `/save` | Snapshot session state to `tasks/session.md` |
| `/load` | Restore context from previous session and orient |
| `/backlog` | Manage GitHub issues — view, pick, create, close work items |
| `/doctor` | Check project health — environment, dependencies, tools |

## Agents

| Agent | Purpose | Context Budget |
|-------|---------|---------------|
| Plan | Break down complex tasks into checkpointed plans | 30% |
| Research | Deep-dive investigation, docs, API exploration | 40% |
| Code Review | Pre-commit diff review for bugs, security, style | 20% |
| Test Runner | Run tests, interpret failures, propose fixes | 25% |
| Build Validator | Compile, type-check, lint, verify build | 15% |
| Code Architect | System design decisions, tradeoff analysis | 35% |
| Code Simplifier | Reduce complexity, flag over-engineering | 25% |
| Verify | Full pre-merge validation pipeline | 30% |

## Tiered Testing

Tests run in order of speed. A failure at any tier blocks the next.

| Command | Tier | What It Runs |
|---------|------|-------------|
| `make test-unit` | 1 | Fast, isolated unit tests |
| `make test-integration` | 2 | Cross-component integration tests |
| `make test-agent` | 3 | Agent behavior and anti-hallucination checks |
| `make test` | All | Full suite, fail-fast |
| `make check` | All | Lint + typecheck + full suite (pre-PR gate) |

## Task Management & Session Continuity

The `tasks/` directory is the "always available" context layer — what Claude reads to orient at session start:

| File | What It Tracks |
|------|---------------|
| `tasks/todo.md` | Current plan, progress, decisions |
| `tasks/lessons.md` | Knowledge base — mistakes, positive patterns, troubleshooting, insights |
| `tasks/tests.md` | Test coverage map, gaps, flaky tests |
| `tasks/session.md` | Active focus, open questions, next steps, git state |

Combined with `PROJECT_INDEX.md` (generated by `/index`), these files let Claude resume any session without re-reading the entire codebase. The philosophy: **compress often, persist the essentials, look up details on demand.**

## Permission Tiers

| Tier | Examples | Behavior |
|------|----------|----------|
| Auto-approved | File read/write, git status/diff/log, make targets, searches | Always allowed |
| User-configured | git commit, git push, package managers, docker | You choose during init |
| Never auto-approved | `rm -rf`, `--force`, `--hard`, secrets access | Always requires confirmation |

## Makefile

Language-aware with auto-detection (Cargo.toml, go.mod, tsconfig.json, pyproject.toml):

| Target | Description |
|--------|-------------|
| `make test` | Run all test tiers |
| `make lint` | Run linter |
| `make fmt` | Auto-format code |
| `make typecheck` | Run type checker |
| `make build` | Compile/build |
| `make check` | lint + typecheck + test (pre-PR gate) |
| `make setup` | Bootstrap dev environment (deps + pre-commit) |
| `make setup-github` | Create issue labels (requires `gh` CLI) |

## GitHub Project Management

Scaffold includes issue templates, a PR template, and label taxonomy:

- **Issue templates** (`.github/ISSUE_TEMPLATE/`) — form-based templates for bugs, features, and tasks with structured fields (severity, scope, acceptance criteria)
- **PR template** (`.github/pull_request_template.md`) — standardized format with What/Why/How sections, test plan checklist, and issue linking
- **Labels** — type labels (bug, feature, task, chore, refactor), priority labels (P0-critical through P3-low), and status labels (needs-triage, ready, blocked, in-progress). Created via `make setup-github` or during init
- **`/backlog` command** — bridges GitHub Issues with local task management. View open issues by priority, pick an issue to start working on (creates branch, sets labels, writes plan), create new issues, or close completed ones

During init, if the GitHub CLI is authenticated, you'll be prompted to create labels and optionally a GitHub Projects kanban board.

## CI/CD

Every scaffolded project gets GitHub Actions workflows:

- **CI workflow** (`.github/workflows/ci.yml`) — runs `make check` (lint + typecheck + test) on every PR and push to main. Language-specific setup included (Python venv, Node.js, Go, Rust toolchain).
- **Release workflow** (`.github/workflows/release.yml`) — triggered by version tags (`v*`). Extracts notes from `CHANGELOG.md` and creates a GitHub Release.

## Pre-commit Hooks & Secret Scanning

Scaffolded projects include a `.pre-commit-config.yaml` with:

- **Common hooks** — trailing whitespace, end-of-file fixer, YAML validation, large file detection, merge conflict detection
- **Language-specific linting** — ruff (Python), eslint (TypeScript), golangci-lint (Go), cargo fmt + clippy (Rust)
- **Secret scanning** — `detect-secrets` catches accidentally staged API keys, tokens, and credentials

To activate: `pip install pre-commit && pre-commit install`

## Docker (Optional)

When enabled during init, adds production-ready Docker support:

- **Dockerfile** — language-specific with multi-stage builds (Go, Rust, TypeScript) or slim images (Python)
- **docker-compose.yml** — app service with commented-out database example

## Ralph Wiggum (Optional)

[Ralph Wiggum](https://ralph-wiggum.ai/) is an autonomous AI coding loop. When enabled during init, it adds:

- `scripts/ralph-loop.sh` — iterative loop: plan, build, test, commit, repeat
- `PROMPT_build.md` — single-task build cycle prompt
- `PROMPT_plan.md` — plan analysis/creation prompt

Each iteration runs with a fresh context window. Progress persists via `tasks/todo.md`.

```bash
# Autonomous planning
./scripts/ralph-loop.sh plan

# Autonomous building
./scripts/ralph-loop.sh build
```

## Graceful Rollback

If scaffold fails mid-run, it automatically detects files created during the run and offers to clean them up. In non-interactive mode, cleanup happens automatically. Pre-existing files are never deleted.

## Project Structure

**Before** (what you clone):

```
scaffold/
├── scaffold                    # Init script (removed after init)
├── templates/                  # Language configs (removed after init)
│   ├── python/                 #   CONVENTIONS.md, pyproject.toml.tmpl, ruff.toml, ...
│   ├── typescript/             #   CONVENTIONS.md, package.json.tmpl, tsconfig.json, ...
│   ├── go/                     #   CONVENTIONS.md, go.mod.tmpl, ...
│   ├── rust/                   #   CONVENTIONS.md, Cargo.toml.tmpl, ...
│   └── ralph/                  #   ralph-loop.sh, PROMPT_build.md, PROMPT_plan.md
├── CLAUDE.md                   # Agent constitution (with placeholders)
├── .claude/
│   ├── settings.json           # Permission defaults
│   ├── skills/                 # 14 slash commands
│   └── hooks/                  # Main branch protection
├── .github/
│   ├── ISSUE_TEMPLATE/         # Bug, feature, task templates
│   └── pull_request_template.md
├── agents/                     # 8 agent specs
├── tasks/                      # Plan, lessons, test registry, session state
├── tests/                      # Tier directories
├── scratch/                    # Subagent workspace
├── Makefile                    # Language-aware dev tasks
└── ...
```

**After** `./scaffold` (e.g., Python + Ralph Wiggum):

```
my-api/
├── CLAUDE.md                   # Customized with project name + Python conventions
├── GETTING_STARTED.md          # First-session onboarding guide
├── .claude/
│   ├── settings.json           # Permissions from your choices
│   ├── skills/                 # 14 slash commands
│   └── hooks/                  # protect-main-branch.sh
├── .github/
│   ├── ISSUE_TEMPLATE/         # Bug, feature, task issue forms
│   ├── workflows/
│   │   ├── ci.yml              # Lint + typecheck + test on PR
│   │   └── release.yml         # GitHub Release on version tag
│   └── pull_request_template.md
├── agents/                     # 8 agent specifications
├── tasks/
│   ├── todo.md                 # Your project plan
│   ├── lessons.md              # Knowledge base
│   ├── tests.md                # Test registry template
│   └── session.md              # Session state for /save and /load
├── tests/
│   ├── unit/
│   ├── integration/
│   └── agent/
├── scratch/
├── Makefile                    # Configured for Python
├── pyproject.toml              # Project config with your name/description
├── ruff.toml                   # Linter config
├── conftest.py                 # Pytest fixtures
├── src/my_api/
│   └── __init__.py
├── scripts/                    # (Ralph Wiggum)
│   └── ralph-loop.sh
├── PROMPT_build.md             # (Ralph Wiggum)
├── PROMPT_plan.md              # (Ralph Wiggum)
├── .pre-commit-config.yaml     # Linting + secret scanning hooks
├── .env.example                # Environment variable template
├── CHANGELOG.md                # Keep a Changelog format
├── SECURITY.md                 # Responsible disclosure policy
├── .gitignore                  # Base + Python entries
└── LICENSE                     # MIT
```
